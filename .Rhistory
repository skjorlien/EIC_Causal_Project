s %>% plot_weights()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_weights.jpeg")),
width=7, height=7, units="in")
s %>% plot_placebos()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_placebos.jpeg")),
width=7, height=7, units="in")
}
}
######## Declare variables of interest ####################
### Note: the population variables follow the convention pop_bmAGE
### Where age is one of the following: U20, WA, 65o
###########################################################
dep.vars <- c("lab", "pov")
# apply(expand.grid(vars, vis), 1, paste, collapse=".")
#TODO:
# Redo the kitchen sink
# redo the no oldies
# pare down more...
# mean vars are the predictors based on pretreatment mean
mean.vars.lab <- c("rpcpi", "rpcgdp", generate_pop_vars(), "density", "pov")
mean.vars.pov <- c("rpcpi", "rpcgdp", generate_pop_vars(), "density", "lab")
# lag vars are the predictors that match a specific year in the pre-treatment period
# use syntax "var_year"
lag.vars.lab.ca <- c("lab_2008", "lab_2011", "lab_2015")
lag.vars.pov.ca <- c("pov_2008", "pov_2011", "pov_2015")
lag.vars.lab.nc <- c("lab_2008", "lab_2011", "lab_2014")
lag.vars.pov.nc <- c("pov_2008", "pov_2011", "pov_2014")
####################### RUN EVERYTHING TO HERE #########################
############# Then, Run Some Models ####################
dir.name <- "1_Kitchen_Sink"
generate_synth("ca", dep.vars[1], mean.vars.lab, lag.vars.lab.ca, dir.name, plots = T)
generate_synth("nc", dep.vars[1], mean.vars.lab, lag.vars.lab.nc, dir.name, plots = T)
generate_synth("ca", dep.vars[2], mean.vars.pov, lag.vars.pov.ca, dir.name, plots = T)
generate_synth("nc", dep.vars[2], mean.vars.pov, lag.vars.pov.nc, dir.name, plots = T)
race <- c("b", "w", "n")
sex <- c("m", "f")
age <- c("U20", "WA", "65o")
apply(expand.grid(race, sex), 1, paste, collapse="")
apply(expand.grid(race, sex, age), 1, paste, collapse="")
##################################
# Author: Scott Kjorlien
# Date: 5/9/2022
# Description:
#     Implementation of the tidysynth package for this project
#     Wrote the following helper functions:
#       generate_mean_predictors takes a list of variable names (as strings)
#               and outputs a synth with those predictors built in
#       generate_lab_predictors takes a list of variables names with the structure "var_year"
#               the year is the lag reference. outputs a synth with those predictors built in
#       synth.out build the synthetic control model
#       generate_synth switches between models of interest, and allows for better user interface
#               includes option to output standard synth figures.
#########################################
rm(list=ls())
generate_pop_vars <- function(){
pref <- "pop_"
race <- c("b", "w", "n")
sex <- c("m", "f")
age <- c("U20", "WA", "65o")
out <- list()
for(i in 1:length(race)){
for(j in 1:length(sex)){
for(k in 1:length(age)){
out <- out %>% append(paste0(pref, race[i], sex[j], age[k]))
}
}
}
unlist(out)
}
generate_mean_predictors <- function(synth, var.list, b_time, i_time) {
for(i in 1:length(var.list)){
x <- sym(var.list[i])
synth <- synth %>% generate_predictor(time_window=b_time:i_time, !!x := mean(!!x, na.rm=TRUE))
}
synth
}
generate_lag_predictors <- function(synth, lag.vars){
## parse lag.vars into two lists: var and year
vars <- lag.vars %>%
sapply(str_split, "_") %>%
sapply("[[", 1) %>%
unname()
years <- lag.vars %>%
sapply(str_split, "_") %>%
sapply("[[", 2) %>%
sapply(strtoi) %>%
unname()
# loop through vars and build the predictor
for(i in 1:length(vars)){
x <- sym(vars[i])
y <- sym(lag.vars[i])
synth <- synth %>% generate_predictor(time_window=years[i], !!y := !!x)
}
synth
}
synth.out <- function(df, dep.var, i_unit, i_time, mean.vars, lag.vars) {
dep.var <- sym(dep.var)
b_time <- df %>% select(year) %>% min()
synth <- df %>%
# initial the synthetic control object
synthetic_control(outcome = !!dep.var, # outcome
unit = state, # unit index in the panel data
time = year, # time index in the panel data
i_unit = i_unit, # unit where the intervention occurred
i_time = i_time, # time period when the intervention occurred
generate_placebos=TRUE # generate placebo synthetic controls (for inference)
) %>%
generate_mean_predictors(mean.vars, b_time, i_time) %>%
generate_lag_predictors(lag.vars) %>%
generate_weights(optimization_window = b_time:i_time, margin_ipop = .02,sigf_ipop = 7,bound_ipop = 6 # optimizer options
) %>%
# Generate the synthetic control
generate_control()
}
generate_synth <- function(model, dep.var, mean.vars, lag.vars, dir.name, plots=FALSE){
if(model == "ca"){
df <- read_csv(here("data/clean/working_data.csv")) %>%
filter(ca_model == 1)
i_time <- 2015
i_unit <- "California"
} else if(model=="nc"){
df <- read_csv(here("data/clean/working_data.csv")) %>%
filter(nc_model == 1)
i_time <- 2014
i_unit <- "North Carolina"
}
s <- synth.out(df, dep.var, i_unit, i_time, mean.vars, lag.vars)
s %>% plot_trends()
if(plots){
s %>% plot_trends()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_trend.jpeg")),
width=7, height=7, units="in")
s %>% plot_differences()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_diff.jpeg")),
width=7, height=7, units="in")
s %>% plot_weights()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_weights.jpeg")),
width=7, height=7, units="in")
s %>% plot_placebos()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_placebos.jpeg")),
width=7, height=7, units="in")
}
}
######## Declare variables of interest ####################
### Note: the population variables follow the convention pop_bmAGE
### Where age is one of the following: U20, WA, 65o
###########################################################
dep.vars <- c("lab", "pov")
# mean vars are the predictors based on pretreatment mean
mean.vars.lab.ca <- c("rpcpi", "rpcgdp", "density", "pov", "pop_wfU20", "pop_nf65o", "pop_wmU20", "pop_nmU20")
mean.vars.pov.ca <- c("rpcpi", "rpcgdp", "density", "pop_nf650", "pop_wmWA", "pop_wfWA", "pop_bfU20")
mean.vars.lab.nc <- c("rpcpi", "rpcgdp", "density", "pov", "pop_nmWA", "pop_nfWA", "pop_nmU20", "pop_nfU20")
mean.vars.pov.nc <- c("rpcpi", "rpcgdp", "density", "pop_bf65o", "pop_bfU20", "pop_bfWA", "pop_bmU20")
# lag vars are the predictors that match a specific year in the pre-treatment period
# use syntax "var_year"
lag.vars.lab.ca <- c("lab_2008", "lab_2011", "lab_2015")
lag.vars.pov.ca <- c("pov_2008", "pov_2011", "pov_2015")
lag.vars.lab.nc <- c("lab_2008", "lab_2011", "lab_2014")
lag.vars.pov.nc <- c("pov_2008", "pov_2011", "pov_2014")
####################### RUN EVERYTHING TO HERE #########################
############# Then, Run Some Models ####################
dir.name <- "3_top_four_demos"
generate_synth("ca", dep.vars[1], mean.vars.lab.ca, lag.vars.lab.ca, dir.name, plots = T)
generate_synth("nc", dep.vars[1], mean.vars.lab.nc, lag.vars.lab.nc, dir.name, plots = T)
generate_synth("ca", dep.vars[2], mean.vars.pov.ca, lag.vars.pov.ca, dir.name, plots = T)
generate_synth("nc", dep.vars[2], mean.vars.pov.nc, lag.vars.pov.nc, dir.name, plots = T)
##################################
# Author: Scott Kjorlien
# Date: 5/9/2022
# Description:
#     Implementation of the tidysynth package for this project
#     Wrote the following helper functions:
#       generate_mean_predictors takes a list of variable names (as strings)
#               and outputs a synth with those predictors built in
#       generate_lab_predictors takes a list of variables names with the structure "var_year"
#               the year is the lag reference. outputs a synth with those predictors built in
#       synth.out build the synthetic control model
#       generate_synth switches between models of interest, and allows for better user interface
#               includes option to output standard synth figures.
#########################################
rm(list=ls())
generate_pop_vars <- function(){
pref <- "pop_"
race <- c("b", "w", "n")
sex <- c("m", "f")
age <- c("U20", "WA", "65o")
out <- list()
for(i in 1:length(race)){
for(j in 1:length(sex)){
for(k in 1:length(age)){
out <- out %>% append(paste0(pref, race[i], sex[j], age[k]))
}
}
}
unlist(out)
}
generate_mean_predictors <- function(synth, var.list, b_time, i_time) {
for(i in 1:length(var.list)){
x <- sym(var.list[i])
synth <- synth %>% generate_predictor(time_window=b_time:i_time, !!x := mean(!!x, na.rm=TRUE))
}
synth
}
generate_lag_predictors <- function(synth, lag.vars){
## parse lag.vars into two lists: var and year
vars <- lag.vars %>%
sapply(str_split, "_") %>%
sapply("[[", 1) %>%
unname()
years <- lag.vars %>%
sapply(str_split, "_") %>%
sapply("[[", 2) %>%
sapply(strtoi) %>%
unname()
# loop through vars and build the predictor
for(i in 1:length(vars)){
x <- sym(vars[i])
y <- sym(lag.vars[i])
synth <- synth %>% generate_predictor(time_window=years[i], !!y := !!x)
}
synth
}
synth.out <- function(df, dep.var, i_unit, i_time, mean.vars, lag.vars) {
dep.var <- sym(dep.var)
b_time <- df %>% select(year) %>% min()
synth <- df %>%
# initial the synthetic control object
synthetic_control(outcome = !!dep.var, # outcome
unit = state, # unit index in the panel data
time = year, # time index in the panel data
i_unit = i_unit, # unit where the intervention occurred
i_time = i_time, # time period when the intervention occurred
generate_placebos=TRUE # generate placebo synthetic controls (for inference)
) %>%
generate_mean_predictors(mean.vars, b_time, i_time) %>%
generate_lag_predictors(lag.vars) %>%
generate_weights(optimization_window = b_time:i_time, margin_ipop = .02,sigf_ipop = 7,bound_ipop = 6 # optimizer options
) %>%
# Generate the synthetic control
generate_control()
}
generate_synth <- function(model, dep.var, mean.vars, lag.vars, dir.name, plots=FALSE){
if(model == "ca"){
df <- read_csv(here("data/clean/working_data.csv")) %>%
filter(ca_model == 1)
i_time <- 2015
i_unit <- "California"
} else if(model=="nc"){
df <- read_csv(here("data/clean/working_data.csv")) %>%
filter(nc_model == 1)
i_time <- 2014
i_unit <- "North Carolina"
}
s <- synth.out(df, dep.var, i_unit, i_time, mean.vars, lag.vars)
s %>% plot_trends()
if(plots){
s %>% plot_trends()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_trend.jpeg")),
width=7, height=7, units="in")
s %>% plot_differences()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_diff.jpeg")),
width=7, height=7, units="in")
s %>% plot_weights()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_weights.jpeg")),
width=7, height=7, units="in")
s %>% plot_placebos()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_placebos.jpeg")),
width=7, height=7, units="in")
}
}
######## Declare variables of interest ####################
### Note: the population variables follow the convention pop_bmAGE
### Where age is one of the following: U20, WA, 65o
###########################################################
dep.vars <- c("lab", "pov")
# mean vars are the predictors based on pretreatment mean
mean.vars.lab.ca <- c("rpcpi", "rpcgdp", "density", "pov", "pop_wfU20", "pop_nf65o", "pop_wmU20", "pop_nmU20")
mean.vars.pov.ca <- c("rpcpi", "rpcgdp", "density", "pop_nf65o", "pop_wmWA", "pop_wfWA", "pop_bfU20")
mean.vars.lab.nc <- c("rpcpi", "rpcgdp", "density", "pov", "pop_nmWA", "pop_nfWA", "pop_nmU20", "pop_nfU20")
mean.vars.pov.nc <- c("rpcpi", "rpcgdp", "density", "pop_bf65o", "pop_bfU20", "pop_bfWA", "pop_bmU20")
# lag vars are the predictors that match a specific year in the pre-treatment period
# use syntax "var_year"
lag.vars.lab.ca <- c("lab_2008", "lab_2011", "lab_2015")
lag.vars.pov.ca <- c("pov_2008", "pov_2011", "pov_2015")
lag.vars.lab.nc <- c("lab_2008", "lab_2011", "lab_2014")
lag.vars.pov.nc <- c("pov_2008", "pov_2011", "pov_2014")
####################### RUN EVERYTHING TO HERE #########################
############# Then, Run Some Models ####################
dir.name <- "3_top_four_demos"
generate_synth("ca", dep.vars[1], mean.vars.lab.ca, lag.vars.lab.ca, dir.name, plots = T)
generate_synth("nc", dep.vars[1], mean.vars.lab.nc, lag.vars.lab.nc, dir.name, plots = T)
generate_synth("ca", dep.vars[2], mean.vars.pov.ca, lag.vars.pov.ca, dir.name, plots = T)
generate_synth("nc", dep.vars[2], mean.vars.pov.nc, lag.vars.pov.nc, dir.name, plots = T)
?plot_placebos
##################################
# Author: Scott Kjorlien
# Date: 5/9/2022
# Description:
#     Implementation of the tidysynth package for this project
#     Wrote the following helper functions:
#       generate_mean_predictors takes a list of variable names (as strings)
#               and outputs a synth with those predictors built in
#       generate_lab_predictors takes a list of variables names with the structure "var_year"
#               the year is the lag reference. outputs a synth with those predictors built in
#       synth.out build the synthetic control model
#       generate_synth switches between models of interest, and allows for better user interface
#               includes option to output standard synth figures.
#########################################
rm(list=ls())
generate_pop_vars <- function(){
pref <- "pop_"
race <- c("b", "w", "n")
sex <- c("m", "f")
age <- c("U20", "WA", "65o")
out <- list()
for(i in 1:length(race)){
for(j in 1:length(sex)){
for(k in 1:length(age)){
out <- out %>% append(paste0(pref, race[i], sex[j], age[k]))
}
}
}
unlist(out)
}
generate_mean_predictors <- function(synth, var.list, b_time, i_time) {
for(i in 1:length(var.list)){
x <- sym(var.list[i])
synth <- synth %>% generate_predictor(time_window=b_time:i_time, !!x := mean(!!x, na.rm=TRUE))
}
synth
}
generate_lag_predictors <- function(synth, lag.vars){
## parse lag.vars into two lists: var and year
vars <- lag.vars %>%
sapply(str_split, "_") %>%
sapply("[[", 1) %>%
unname()
years <- lag.vars %>%
sapply(str_split, "_") %>%
sapply("[[", 2) %>%
sapply(strtoi) %>%
unname()
# loop through vars and build the predictor
for(i in 1:length(vars)){
x <- sym(vars[i])
y <- sym(lag.vars[i])
synth <- synth %>% generate_predictor(time_window=years[i], !!y := !!x)
}
synth
}
synth.out <- function(df, dep.var, i_unit, i_time, mean.vars, lag.vars) {
dep.var <- sym(dep.var)
b_time <- df %>% select(year) %>% min()
synth <- df %>%
# initial the synthetic control object
synthetic_control(outcome = !!dep.var, # outcome
unit = state, # unit index in the panel data
time = year, # time index in the panel data
i_unit = i_unit, # unit where the intervention occurred
i_time = i_time, # time period when the intervention occurred
generate_placebos=TRUE # generate placebo synthetic controls (for inference)
) %>%
generate_mean_predictors(mean.vars, b_time, i_time) %>%
generate_lag_predictors(lag.vars) %>%
generate_weights(optimization_window = b_time:i_time, margin_ipop = .02,sigf_ipop = 7,bound_ipop = 6 # optimizer options
) %>%
# Generate the synthetic control
generate_control()
}
generate_synth <- function(model, dep.var, mean.vars, lag.vars, dir.name, plots=FALSE){
if(model == "ca"){
df <- read_csv(here("data/clean/working_data.csv")) %>%
filter(ca_model == 1)
i_time <- 2015
i_unit <- "California"
} else if(model=="nc"){
df <- read_csv(here("data/clean/working_data.csv")) %>%
filter(nc_model == 1)
i_time <- 2014
i_unit <- "North Carolina"
}
s <- synth.out(df, dep.var, i_unit, i_time, mean.vars, lag.vars)
s %>% plot_trends()
if(plots){
s %>% plot_trends()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_trend.jpeg")),
width=7, height=7, units="in")
s %>% plot_differences()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_diff.jpeg")),
width=7, height=7, units="in")
s %>% plot_weights()
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_weights.jpeg")),
width=7, height=7, units="in")
s %>% plot_placebos(prune = FALSE)
ggsave(here("figures/", paste0(dir.name, "/", model, "_", dep.var, "_placebos.jpeg")),
width=7, height=7, units="in")
}
}
######## Declare variables of interest ####################
### Note: the population variables follow the convention pop_bmAGE
### Where age is one of the following: U20, WA, 65o
###########################################################
dep.vars <- c("lab", "pov")
# mean vars are the predictors based on pretreatment mean
mean.vars.lab.ca <- c("rpcpi", "rpcgdp", "density", "pop_wfU20", "pop_wmU20")
mean.vars.pov.ca <- c("rpcpi", "rpcgdp", "density", "pop_nf65o", "pop_wfWA")
mean.vars.lab.nc <- c("rpcpi", "rpcgdp", "density", "pop_nmWA", "pop_nfWA", "pop_nmU20", "pop_nfU20")
mean.vars.pov.nc <- c("rpcpi", "rpcgdp", "density", "pop_bf65o", "pop_bfU20", "pop_bfWA", "pop_bmU20")
# lag vars are the predictors that match a specific year in the pre-treatment period
# use syntax "var_year"
lag.vars.lab.ca <- c("lab_2008", "lab_2011", "lab_2015")
lag.vars.pov.ca <- c("pov_2008", "pov_2011", "pov_2015")
lag.vars.lab.nc <- c("lab_2008", "lab_2011", "lab_2014")
lag.vars.pov.nc <- c("pov_2008", "pov_2011", "pov_2014")
####################### RUN EVERYTHING TO HERE #########################
####################### Then, Run Some Models ##########################
dir.name <- "4_trim_ca_no_prune"
generate_synth("ca", dep.vars[1], mean.vars.lab.ca, lag.vars.lab.ca, dir.name, plots = T)
generate_synth("nc", dep.vars[1], mean.vars.lab.nc, lag.vars.lab.nc, dir.name, plots = T)
generate_synth("ca", dep.vars[2], mean.vars.pov.ca, lag.vars.pov.ca, dir.name, plots = T)
generate_synth("nc", dep.vars[2], mean.vars.pov.nc, lag.vars.pov.nc, dir.name, plots = T)
rm(list=ls())
## Demographics
out.df <- read_csv(here("data/clean/population.csv")) %>%
mutate(across(contains("pop_"), ~ .x / population))
## GDP
tdf <- read_csv(here("data/clean/state_gdp.csv"))
out.df <- out.df %>%
left_join(tdf, by=c("sfip", "year")) %>%
mutate(rpcgdp = m_gdp*1000000/population) %>%
select(-state.y) %>%
rename("state_abbr" = state.x)
## Personal Income
tdf <- read_csv(here("data/clean/personal_income.csv"))
out.df <- out.df %>%
left_join(tdf, by=c("sfip", "year")) %>%
select(state, everything())
## Poverty and Labor
tdf <- read_csv(here("data/clean/povlab.csv"))
out.df <- out.df %>%
left_join(tdf, by=c("sfip", "year")) %>%
select(-State) %>%
filter(year<=2019)
## Create Density -- Note, You are losing DC intentionally here.
tmp_state <- data.frame(state.name, state.area) %>%
rename("state_name" = state.name,
"state_area" = state.area)
sfips <- fips_codes %>%
select(state_code, state_name) %>%
unique() %>%
left_join(tmp_state) %>%
drop_na() %>%
rename("sfip" = state_code)
out.df <- out.df %>%
left_join(sfips) %>%
select(-state_name) %>%
mutate(density = population/state_area) %>%
filter(sfip != 11)
## join EITC info
tdf <- read_csv(here("data/clean/eitc_by_state.csv")) %>%
slice(1:51) %>%
select(state:eitc, -year_enacted)
out.df <- out.df %>%
left_join(tdf)
View(out.df)
rm(list=ls())
## Demographics
out.df <- read_csv(here("data/clean/population.csv")) %>%
mutate(across(contains("pop_"), ~ .x / population))
## GDP
tdf <- read_csv(here("data/clean/state_gdp.csv"))
out.df <- out.df %>%
left_join(tdf, by=c("sfip", "year")) %>%
mutate(rpcgdp = m_gdp*1000000/population) %>%
select(-state.y) %>%
rename("state_abbr" = state.x)
## Personal Income
tdf <- read_csv(here("data/clean/personal_income.csv"))
out.df <- out.df %>%
left_join(tdf, by=c("sfip", "year")) %>%
select(state, everything())
## Poverty and Labor
tdf <- read_csv(here("data/clean/povlab.csv"))
out.df <- out.df %>%
left_join(tdf, by=c("sfip", "year")) %>%
select(-State) %>%
filter(year<=2019)
## Create Density -- Note, You are losing DC intentionally here.
tmp_state <- data.frame(state.name, state.area) %>%
rename("state_name" = state.name,
"state_area" = state.area)
sfips <- fips_codes %>%
select(state_code, state_name) %>%
unique() %>%
left_join(tmp_state) %>%
drop_na() %>%
rename("sfip" = state_code)
out.df <- out.df %>%
left_join(sfips) %>%
select(-state_name) %>%
mutate(density = population/state_area) %>%
filter(sfip != 11)
## join EITC info
tdf <- read_csv(here("data/clean/eitc_by_state.csv")) %>%
slice(1:51) %>%
select(state:eitc, -year_enacted)
out.df <- out.df %>%
left_join(tdf)
out.df <- out.df %>%
mutate(ca_model = ifelse((refundable_eitc == 0 | state == "California") & state != "North Carolina", 1, 0),
nc_model = ifelse((refundable_eitc == 1 | state == "North Carolina") & state != "California", 1, 0))
write_csv(out.df, here("data/clean/working_data.csv"))
